#!/bin/php

<?php

use ColdBolt\Autoloader;
use ColdBolt\Autoload\Container;
use ColdBolt\Cli\Styles\FontColorStyle;
use ColdBolt\Cli\Styles\ResetStyle;
use ColdBolt\Configuration;
use ColdBolt\Cli\Styles\ConsoleStyle;
use ColdBolt\Tests\TestFinder;

require_once __DIR__ . '/../src/Autoload/Autoloader.php';
Autoloader::register();

$container = new Container;
$consoleStyle = new ConsoleStyle;
$config = $container->get(Configuration::class);

/** @var $testFinder TestFinder */
$testFinder = $container->resolve(TestFinder::class);
$tests_classes = $testFinder->getTests();

$tests_finished = [];

$start_time = time();

foreach ($tests_classes as $tests_class) {
    $tests = $tests_class->getTests();
    $class_name = $tests_class->getName();

    $ctx = $container->resolve($class_name);

    foreach ($tests as $test) {
        $test->run($ctx);
        $tests_finished[] = $test;
    }
}

$i = 0;

foreach ($tests_finished as $test) {
    if($i % 64 === 0) {
        $consoleStyle->newLine();
    }

    if($test->hasError()) {
        if($test->canFail()) {
            $consoleStyle->write(FontColorStyle::COLOR['blue'] . 'F' . ResetStyle::RESET);
            continue;
        }

        $consoleStyle->write(FontColorStyle::COLOR['red'] . 'F' . ResetStyle::RESET);
        continue;
    }

    /** @noinspection DisconnectedForeachInstructionInspection */
    $consoleStyle->write('.');
    $i++;
}

$consoleStyle->newLine(3);
$status_code = 0;
foreach ($tests_finished as $test) {
    if($test->hasError()) {
        if($test->canFail()) {
            $consoleStyle->info($test->getName());
            $consoleStyle->writeln("\t" . $test->getError()->getMessage() . ' on ' . $test->getError()->getFile() . ' at line ' . $test->getError()->getLine());
            $consoleStyle->newLine(2);
            continue;
        }

        $consoleStyle->error($test->getName());
        $consoleStyle->writeln("\t" . $test->getError()->getMessage() . ' on ' . $test->getError()->getFile() . ' at line ' . $test->getError()->getLine());

        $consoleStyle->newLine(2);
        $status_code = 1;
        continue;
    }

    $i++;
}

//TODO: Prety output
$consoleStyle->newLine(2);
$consoleStyle->writeln('Time ' . time() - $start_time . 'ms');
exit($status_code);